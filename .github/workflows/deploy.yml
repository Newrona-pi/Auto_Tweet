name: CI/CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  # 1. CI Job: Test Build
  build-check:
    name: ğŸ—ï¸ Quality Check (Build)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      # ãƒ“ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°ã“ã“ã§æ­¢ã¾ã‚‹ï¼‰
      # æ³¨: Vercelä¸Šã§ã®ãƒ“ãƒ«ãƒ‰ã¨ç’°å¢ƒã‚’åˆã‚ã›ã‚‹ãŸã‚ã€æœ€ä½é™ã®å¤‰æ•°ã‚’ã‚»ãƒƒãƒˆ
      - name: Run Build
        run: npm run build
        env:
          # DBæ¥ç¶šãŒãªã„ã¨ãƒ“ãƒ«ãƒ‰ã‚³ã‚±ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹å ´åˆç”¨ï¼ˆä»Šå›ã¯Prismaãªã®ã§å‹ç”Ÿæˆã ã‘ã§OKãªã¯ãšã ãŒå¿µã®ãŸã‚ï¼‰
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy" 
          # ãƒ“ãƒ«ãƒ‰æ™‚ã«APIã‚­ãƒ¼ã®æœ‰ç„¡ãƒã‚§ãƒƒã‚¯ãŒã‚ã‚‹ãŸã‚ãƒ€ãƒŸãƒ¼ã‚’å…¥ã‚Œã‚‹
          OPENAI_API_KEY: "dummy-key"
          SKIP_ENV_VALIDATION: "true"

  # 2. CD Job: Deploy to Vercel
  deploy:
    name: ğŸš€ Deploy to Vercel
    needs: build-check
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID2 }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID2 }}

      - name: Build Project Artifacts
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID2 }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID2 }}

      - name: Deploy Project Artifacts to Vercel
        run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID2 }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID2 }}
